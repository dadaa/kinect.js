<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this file,
   - You can obtain one at http://mozilla.org/MPL/2.0/.  -->
<html lang="ja" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>kinect.js simple sample</title>
    <style type="text/css">
    html {
        background-color: black;
    }
    #main-canvas {
        background-color: black;
        width: 100%;
    }
    </style>

    <script src="js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript">
        var MAX_DEPTH = 2047;
        var Main = {
            start: function(context) {
                var kinect = document.kinect;
                if (!kinect) {
                    alert("no kinect");
                    return;
                }
                Main.kinect = kinect;
                Main.video_buffer = kinect.createVideoBuffer();
                Main.depth_buffer = kinect.createDepthBuffer();
                var canvas = document.getElementById("main-canvas");
                Main.context = canvas.getContext("2d");
                Main.imagedata = Main.context.createImageData(640, 480);
                for (var i = 0, n = 640*480*4; i < n; i++) {
                    Main.imagedata.data[i] = 255;
                }
                Main.next();
            },
            next: function() {
                Main.kinect.getDepthTo(Main.depth_buffer);
                Main.kinect.getVideoTo(Main.video_buffer);
                for (var i = 0, n = Main.depth_buffer.length; i < n; i++) {
                    var depth = Main.depth_buffer[i];
                    var depth255 = 255-Math.floor(depth/MAX_DEPTH*255);
                    var index = i * 4;
                    if (depth255 < 150) {
                        Main.imagedata.data[index] = 255;
                        Main.imagedata.data[index+1] = 255;
                        Main.imagedata.data[index+2] = 255;
                        continue;
                    }
                    var colorIndex = i * 3;
                    Main.imagedata.data[index] = Main.video_buffer[colorIndex];
                    Main.imagedata.data[index+1] = Main.video_buffer[colorIndex+1];
                    Main.imagedata.data[index+2] = Main.video_buffer[colorIndex+2];
                }
                Main.context.putImageData(Main.imagedata, 0, 0);
                setTimeout(Main.next, 10);
            }
        };

        $(document).ready(function() {
            Main.start();
        });
    </script>
</head>
<!--
http://127.0.0.1/WORKS/MOZILLA/projects/mecha-mozilla/kinect.js/samples/webpages/simple.html
-->
<body>
<canvas id="main-canvas" width="640" height="480"></canvas>
</body>
</html>